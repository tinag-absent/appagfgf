<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>チャットログビューア — 海蝕機関</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07090f;--panel:#0c1018;--panel2:#111620;--border:#1a2030;--border2:#263040;
  --cyan:#00d4ff;--cyan-dim:#002838;--green:#00e676;--green-dim:#002810;
  --yellow:#ffd740;--yellow-dim:#2a2000;--red:#ff5252;--red-dim:#2a0808;
  --purple:#ce93d8;--text:#cdd6e8;--text2:#7a8aa0;--text3:#445060;
  --mono:'Share Tech Mono',monospace;--sans:'Noto Sans JP',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:13px;min-height:100vh;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,212,255,.01) 3px,rgba(0,212,255,.01) 4px);}

.hdr{background:var(--panel);border-bottom:1px solid var(--border2);padding:0 24px;height:50px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;}
.hdr-dot{width:8px;height:8px;border-radius:50%;background:var(--purple);box-shadow:0 0 8px var(--purple);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.hdr-title{font-family:var(--mono);font-size:12px;color:var(--purple);letter-spacing:.2em;}
.hdr-sub{font-family:var(--mono);font-size:10px;color:var(--text3);}
.hdr-sep{flex:1;}
.hdr-count{font-family:var(--mono);font-size:10px;color:var(--text3);}
.btn{background:none;border:1px solid var(--border2);color:var(--text2);font-family:var(--mono);font-size:10px;padding:6px 14px;cursor:pointer;letter-spacing:.08em;transition:all .15s;}
.btn:hover{border-color:var(--purple);color:var(--purple);}
.btn-red{border-color:var(--red);color:var(--red);}
.btn-red:hover{background:var(--red-dim);}

.main{display:flex;flex:1;overflow:hidden;height:calc(100vh - 50px);}

/* Conversation list */
.convo-pane{width:260px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.convo-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;}
.convo-title{font-family:var(--mono);font-size:11px;color:var(--purple);letter-spacing:.1em;flex:1;}
.convo-list{overflow-y:auto;flex:1;}
.convo-item{padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
.convo-item:hover{background:var(--panel2);}
.convo-item.active{background:#12081e;border-left:2px solid var(--purple);}
.convo-id{font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:3px;}
.convo-preview{font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;}
.convo-meta{display:flex;justify-content:space-between;align-items:center;}
.convo-count{font-family:var(--mono);font-size:10px;color:var(--text3);}
.convo-time{font-family:var(--mono);font-size:9px;color:var(--text3);}

/* Messages pane */
.msg-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;}

.msg-toolbar{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.msg-filter{background:var(--panel2);border:1px solid var(--border2);color:var(--text);padding:6px 10px;font-family:var(--sans);font-size:12px;outline:none;width:180px;}
.msg-filter:focus{border-color:var(--purple);}
.keyword-highlight{background:var(--yellow);color:var(--bg);padding:0 2px;border-radius:1px;font-weight:bold;}

.msg-list{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px;}

.msg-bubble{display:flex;gap:10px;max-width:80%;}
.msg-bubble.system{max-width:100%;justify-content:center;}
.msg-avatar{width:32px;height:32px;border-radius:2px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:11px;font-weight:bold;flex-shrink:0;align-self:flex-start;}
.msg-body{flex:1;}
.msg-header{display:flex;gap:8px;align-items:center;margin-bottom:4px;}
.msg-sender{font-family:var(--mono);font-size:11px;font-weight:bold;}
.msg-time{font-family:var(--mono);font-size:9px;color:var(--text3);}
.msg-id-badge{font-family:var(--mono);font-size:9px;color:var(--text3);padding:1px 6px;border:1px solid var(--border2);}
.msg-text{background:var(--panel2);border:1px solid var(--border);padding:10px 14px;font-size:13px;line-height:1.6;color:var(--text);}
.msg-text.system-msg{background:var(--panel);border-color:var(--border2);color:var(--text3);font-family:var(--mono);font-size:10px;text-align:center;padding:6px 12px;}
.msg-actions{display:flex;gap:6px;margin-top:4px;}
.msg-action-btn{background:none;border:none;font-family:var(--mono);font-size:9px;color:var(--text3);cursor:pointer;padding:2px 6px;transition:color .15s;}
.msg-action-btn:hover{color:var(--red);}
.msg-deleted{background:var(--red-dim);border:1px solid var(--red);color:var(--red);padding:8px 14px;font-family:var(--mono);font-size:10px;font-style:italic;}
.msg-arg-flag{display:inline-flex;align-items:center;gap:4px;background:var(--yellow-dim);border:1px solid var(--yellow);color:var(--yellow);font-family:var(--mono);font-size:9px;padding:2px 6px;margin-top:4px;}

/* Stats bar */
.stats-bar{background:var(--panel);border-bottom:1px solid var(--border);padding:8px 20px;display:flex;gap:24px;flex-shrink:0;}
.stat{display:flex;flex-direction:column;}
.stat-val{font-family:var(--mono);font-size:16px;color:var(--cyan);}
.stat-lbl{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:.08em;}

.empty{height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;color:var(--text3);}
.empty-icon{font-family:var(--mono);font-size:36px;opacity:.3;}

/* Danger zone */
.danger-bar{background:var(--panel);border-top:1px solid var(--border);padding:10px 20px;display:flex;gap:10px;align-items:center;flex-shrink:0;}
.danger-label{font-family:var(--mono);font-size:10px;color:var(--text3);}

.toast{position:fixed;bottom:20px;right:20px;background:var(--panel);border:1px solid var(--purple);color:var(--purple);font-family:var(--mono);font-size:11px;padding:10px 16px;opacity:0;transform:translateY(8px);transition:all .25s;pointer-events:none;z-index:9998;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.warn{border-color:var(--yellow);color:var(--yellow);}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border2);}
</style>
</head>
<body>
<div class="hdr">
  <div class="hdr-dot"></div>
  <div class="hdr-title">KAISHOKU // CHAT VIEWER</div>
  <div class="hdr-sub">チャットログビューア / モデレーター</div>
  <div class="hdr-sep"></div>
  <span class="hdr-count" id="totalCount">—</span>
  <button class="btn" onclick="loadAll()">↺ 再読込</button>
  <button class="btn btn-red" onclick="clearAllLogs()">✕ 全ログ削除</button>
</div>

<div class="main">
  <!-- Conversation list -->
  <div class="convo-pane">
    <div class="convo-hdr">
      <div class="convo-title">会話一覧</div>
    </div>
    <div class="convo-list" id="convoList"></div>
  </div>

  <!-- Messages -->
  <div class="msg-pane">
    <div class="stats-bar" id="statsBar">
      <div class="stat"><div class="stat-val" id="stTotal">0</div><div class="stat-lbl">総メッセージ</div></div>
      <div class="stat"><div class="stat-val" id="stConvos">0</div><div class="stat-lbl">会話数</div></div>
      <div class="stat"><div class="stat-val" id="stKeywords">0</div><div class="stat-lbl">ARGキーワード検出</div></div>
      <div class="stat"><div class="stat-val" id="stUsers">0</div><div class="stat-lbl">参加ユーザー</div></div>
    </div>

    <div class="msg-toolbar">
      <input class="msg-filter" id="filterInput" placeholder="キーワード検索..." oninput="filterMessages()">
      <span style="font-family:var(--mono);font-size:10px;color:var(--text3)" id="filterCount"></span>
      <div style="flex:1"></div>
      <button class="btn" onclick="exportConvo()" id="exportBtn" style="display:none">↓ 会話エクスポート</button>
      <button class="btn btn-red" onclick="deleteConvo()" id="deleteConvoBtn" style="display:none">✕ この会話を削除</button>
    </div>

    <div class="msg-list" id="msgList">
      <div class="empty">
        <div class="empty-icon">[ CHAT ]</div>
        <p>左の会話を選択してください</p>
        <p style="font-size:11px;font-family:var(--mono)">localStorageの kaishoku_messages を読み込みます</p>
      </div>
    </div>

    <div class="danger-bar" id="dangerBar" style="display:none">
      <span class="danger-label">選択中の会話:</span>
      <button class="btn btn-red" onclick="deleteConvo()">✕ この会話を削除</button>
      <button class="btn" onclick="exportConvo()">↓ エクスポート (JSON)</button>
    </div>
  </div>
</div>

<div class="toast" id="toastEl"></div>

<script>
// ARG keywords to highlight
const ARG_KEYWORDS = ['海は削れている','海蝕プロジェクト','収束','西堂','次元','監視されている','封印','観測者は存在しない','記憶','境界','消滅'];

let allMessages = {};
let selectedChatId = null;
let users = [];

const COLORS = ['#00d4ff','#00e676','#ffd740','#ce93d8','#ff9800','#4fc3f7','#f06292'];
const userColors = {};
let colorIdx = 0;

function getUserColor(id) {
  if (!userColors[id]) userColors[id] = COLORS[colorIdx++ % COLORS.length];
  return userColors[id];
}

function loadAll() {
  try {
    const raw = localStorage.getItem('kaishoku_messages');
    allMessages = raw ? JSON.parse(raw) : {};
  } catch(e) { allMessages = {}; }

  try {
    const raw = localStorage.getItem('kaishoku_users');
    users = raw ? JSON.parse(raw) : [];
  } catch(e) { users = []; }

  // Stats
  let total = 0, keywords = 0;
  const senderSet = new Set();
  Object.values(allMessages).forEach(msgs => {
    total += msgs.length;
    msgs.forEach(m => {
      if (m.senderId) senderSet.add(m.senderId);
      if (ARG_KEYWORDS.some(k => (m.content||'').includes(k))) keywords++;
    });
  });

  document.getElementById('stTotal').textContent = total;
  document.getElementById('stConvos').textContent = Object.keys(allMessages).length;
  document.getElementById('stKeywords').textContent = keywords;
  document.getElementById('stUsers').textContent = senderSet.size;
  document.getElementById('totalCount').textContent = `総メッセージ: ${total}件`;

  renderConvoList();
  if (selectedChatId) renderMessages();
}

function renderConvoList() {
  const el = document.getElementById('convoList');
  const keys = Object.keys(allMessages);
  if (keys.length === 0) {
    el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-family:var(--mono);font-size:11px">チャットログがありません<br>ゲーム内でチャットを送信してください</div>';
    return;
  }
  el.innerHTML = keys.map(chatId => {
    const msgs = allMessages[chatId] || [];
    const last = msgs[msgs.length-1];
    const hasArg = msgs.some(m => ARG_KEYWORDS.some(k=>(m.content||'').includes(k)));
    return `<div class="convo-item ${chatId===selectedChatId?'active':''}" onclick="selectConvo('${chatId}')">
      <div class="convo-id">${chatId} ${hasArg?'<span style="color:var(--yellow)">★ARG</span>':''}</div>
      <div class="convo-preview">${last?.content || '(メッセージなし)'}</div>
      <div class="convo-meta">
        <span class="convo-count">${msgs.length}件</span>
        <span class="convo-time">${last?.timestamp ? new Date(last.timestamp).toLocaleDateString('ja-JP') : '—'}</span>
      </div>
    </div>`;
  }).join('');
}

function selectConvo(chatId) {
  selectedChatId = chatId;
  document.getElementById('dangerBar').style.display = 'flex';
  document.getElementById('exportBtn').style.display = 'block';
  document.getElementById('deleteConvoBtn').style.display = 'block';
  renderConvoList();
  renderMessages();
}

function renderMessages() {
  const msgs = (allMessages[selectedChatId] || []);
  const q = document.getElementById('filterInput').value.toLowerCase();
  const filtered = q ? msgs.filter(m => (m.content||'').toLowerCase().includes(q) || (m.senderName||'').toLowerCase().includes(q)) : msgs;

  document.getElementById('filterCount').textContent = q ? `${filtered.length}/${msgs.length}件` : '';

  const el = document.getElementById('msgList');
  if (filtered.length === 0) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">[ 0 ]</div><p>${q?'該当するメッセージがありません':'メッセージがありません'}</p></div>`;
    return;
  }

  el.innerHTML = filtered.map((m, i) => {
    const col = getUserColor(m.senderId || m.sender || 'unknown');
    const initials = (m.senderName || m.sender || '?').charAt(0);
    const time = m.timestamp ? new Date(m.timestamp).toLocaleString('ja-JP') : '—';
    const argMatches = ARG_KEYWORDS.filter(k => (m.content||'').includes(k));
    let content = esc(m.content || '');
    // Highlight ARG keywords
    if (q) {
      const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
      content = content.replace(re, '<span class="keyword-highlight">$&</span>');
    }
    ARG_KEYWORDS.forEach(k => {
      content = content.replace(new RegExp(esc(k).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'), `<span class="keyword-highlight" style="background:var(--yellow)">${esc(k)}</span>`);
    });

    return `<div class="msg-bubble ${m.type==='system'?'system':''}">
      ${m.type!=='system'?`<div class="msg-avatar" style="background:${col}22;color:${col};border:1px solid ${col}44">${initials}</div>`:''}
      <div class="msg-body">
        ${m.type!=='system'?`<div class="msg-header">
          <span class="msg-sender" style="color:${col}">${esc(m.senderName||m.sender||'—')}</span>
          <span class="msg-id-badge">${esc(m.senderId||'—')}</span>
          <span class="msg-time">${time}</span>
          ${m.read===false?'<span style="font-family:var(--mono);font-size:9px;color:var(--cyan)">未読</span>':''}
        </div>`:''}
        <div class="msg-text ${m.type==='system'?'system-msg':''}">${content}</div>
        ${argMatches.length?`<div class="msg-arg-flag">★ ARGキーワード: ${argMatches.map(k=>esc(k)).join(', ')}</div>`:''}
        ${m.type!=='system'?`<div class="msg-actions">
          <button class="msg-action-btn" onclick="deleteMsg('${selectedChatId}',${i})">✕ 削除</button>
          <button class="msg-action-btn" onclick="copyMsg('${esc(m.content||'')}')">⧉ コピー</button>
        </div>`:''}
      </div>
    </div>`;
  }).join('');

  // Scroll to bottom
  el.scrollTop = el.scrollHeight;
}

function filterMessages() { renderMessages(); }

function deleteMsg(chatId, idx) {
  if (!confirm('このメッセージを削除しますか？')) return;
  if (allMessages[chatId]) {
    allMessages[chatId].splice(idx, 1);
    localStorage.setItem('kaishoku_messages', JSON.stringify(allMessages));
    renderMessages();
    renderConvoList();
    toast('メッセージを削除しました');
  }
}

function deleteConvo() {
  if (!selectedChatId) return;
  if (!confirm(`会話「${selectedChatId}」を削除しますか？`)) return;
  delete allMessages[selectedChatId];
  localStorage.setItem('kaishoku_messages', JSON.stringify(allMessages));
  selectedChatId = null;
  document.getElementById('dangerBar').style.display = 'none';
  document.getElementById('msgList').innerHTML = '<div class="empty"><div class="empty-icon">[ 削除済み ]</div><p>会話を削除しました</p></div>';
  loadAll();
  toast('会話を削除しました', 'warn');
}

function clearAllLogs() {
  if (!confirm('すべてのチャットログを削除しますか？この操作は取り消せません。')) return;
  localStorage.removeItem('kaishoku_messages');
  allMessages = {};
  selectedChatId = null;
  loadAll();
  document.getElementById('msgList').innerHTML = '<div class="empty"><div class="empty-icon">[ 空 ]</div><p>チャットログをクリアしました</p></div>';
  toast('全ログを削除しました', 'warn');
}

function exportConvo() {
  if (!selectedChatId) return;
  const blob = new Blob([JSON.stringify({chatId:selectedChatId,messages:allMessages[selectedChatId]},null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`chat-${selectedChatId}.json`; a.click();
  toast('エクスポートしました ✓');
}

function copyMsg(text) {
  navigator.clipboard?.writeText(text).then(()=>toast('コピーしました ✓'));
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(msg,type=''){
  const t=document.getElementById('toastEl');
  t.textContent=msg;t.className='toast show '+type;
  clearTimeout(t._t);t._t=setTimeout(()=>t.className='toast',2800);
}

loadAll();
</script>
</body>
</html>
