<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>æ©Ÿé–¢å“¡ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ â€” æµ·è•æ©Ÿé–¢</title>
  <link rel="icon" type="image/png" href="./images/favicon.png">
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/sidebar.css">
  <link rel="stylesheet" href="./css/mobile.css">
  <style>
    .st-header {
      border-left: 4px solid var(--primary);
      padding-left: 1rem;
      margin-bottom: 1.5rem;
    }
    /* track selector */
    .track-selector {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    .track-btn {
      padding: .4rem 1rem;
      background: rgba(0,0,0,.3);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted-foreground);
      font-family: 'JetBrains Mono', monospace;
      font-size: .72rem;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .2s;
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .track-btn:hover, .track-btn.active {
      border-color: var(--tc, var(--primary));
      color: var(--tc, var(--primary));
      background: color-mix(in srgb, var(--tc, var(--primary)) 10%, transparent);
    }

    /* Progress bar */
    .st-progress-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: .75rem;
      margin-bottom: 2rem;
    }
    .st-progress-card {
      background: rgba(0,0,0,.3);
      border: 1px solid rgba(255,255,255,.07);
      padding: .9rem 1rem;
    }
    .stp-track {
      font-family: 'JetBrains Mono', monospace;
      font-size: .62rem;
      text-transform: uppercase;
      margin-bottom: .4rem;
    }
    .stp-bar {
      height: 4px;
      background: rgba(255,255,255,.08);
      margin-bottom: .3rem;
    }
    .stp-fill {
      height: 100%;
      transition: width .8s ease;
    }
    .stp-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: .65rem;
      color: var(--muted-foreground);
    }

    /* Tree canvas */
    .st-tree-wrap {
      position: relative;
      overflow-x: auto;
    }
    .st-tree {
      min-width: 700px;
      padding: 1.5rem 0;
    }
    .st-row {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 0;
      position: relative;
    }

    /* Connector SVG */
    .st-connectors {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      overflow: visible;
    }

    /* Skill node */
    .sk-node {
      width: 120px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      padding-top: 32px; /* space for connector lines */
    }
    .sk-node:first-child { padding-top: 0; }
    .sk-bubble {
      width: 64px; height: 64px;
      border-radius: 50%;
      border: 2px solid;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all .2s;
      position: relative;
      background: var(--background);
    }
    .sk-bubble.unlocked {
      border-color: var(--sk-color);
      box-shadow: 0 0 16px color-mix(in srgb, var(--sk-color) 40%, transparent);
    }
    .sk-bubble.locked {
      border-color: rgba(255,255,255,.12);
      filter: grayscale(1);
      opacity: .5;
      cursor: not-allowed;
    }
    .sk-bubble.unlocked:hover {
      transform: scale(1.1);
      box-shadow: 0 0 24px color-mix(in srgb, var(--sk-color) 60%, transparent);
    }
    .sk-level-badge {
      position: absolute;
      bottom: -4px; right: -4px;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--sk-color);
      border: 2px solid var(--background);
      font-family: 'JetBrains Mono', monospace;
      font-size: .6rem;
      color: var(--background);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .sk-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: .68rem;
      color: var(--foreground);
      text-align: center;
      margin-top: .5rem;
      text-transform: uppercase;
      line-height: 1.3;
    }
    .sk-node.locked .sk-name { color: var(--muted-foreground); }

    /* connector lines via absolute pos */
    .sk-connector-down {
      position: absolute;
      top: 64px;
      left: 50%;
      width: 1px;
      height: 32px;
      background: linear-gradient(180deg, var(--sk-color), rgba(255,255,255,.1));
      transform: translateX(-50%);
      z-index: 1;
    }
    .sk-connector-down.locked { background: rgba(255,255,255,.08); }

    /* Detail popup */
    .sk-detail {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.15);
      padding: 1.75rem 2rem;
      max-width: 440px;
      width: 90%;
      z-index: 300;
    }
    .sk-detail.open { display: block; animation: sk-pop .25s ease; }
    @keyframes sk-pop { from{opacity:0;transform:translate(-50%,-48%)} to{opacity:1;transform:translate(-50%,-50%)} }
    .sk-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.6);
      z-index: 299;
      backdrop-filter: blur(2px);
    }
    .sk-overlay.open { display: block; }
    .sdd-header {
      display: flex; align-items: center; gap: 1rem;
      margin-bottom: 1.25rem;
      padding-bottom: .75rem;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sdd-icon { font-size: 2.5rem; }
    .sdd-close {
      margin-left: auto;
      background: none;
      border: 1px solid rgba(255,255,255,.15);
      color: var(--muted-foreground);
      cursor: pointer;
      padding: .3rem .7rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: .75rem;
    }
    .sdd-close:hover { color: var(--destructive); border-color: var(--destructive); }
    .sdd-effects {
      margin-top: 1rem;
    }
    .sdd-effect {
      display: flex;
      gap: .6rem;
      align-items: flex-start;
      padding: .4rem 0;
      border-bottom: 1px solid rgba(255,255,255,.05);
      font-size: .82rem;
      color: var(--muted-foreground);
    }
    .sdd-bullet {
      color: var(--primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: .7rem;
      flex-shrink: 0;
      padding-top: 2px;
    }
    .sdd-req {
      margin-top: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: .68rem;
      color: rgba(255,255,255,.3);
    }
    .sdd-unlock-btn {
      margin-top: 1rem;
      width: 100%;
      padding: .75rem;
      background: rgba(0,255,255,.1);
      border: 1px solid var(--primary);
      color: var(--primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      cursor: pointer;
      transition: all .2s;
    }
    .sdd-unlock-btn:hover { background: rgba(0,255,255,.18); }
    .sdd-unlock-btn:disabled { opacity: .35; cursor: not-allowed; }
    .sdd-locked-notice {
      margin-top: .75rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: .7rem;
      color: rgba(239,68,68,.7);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar"></aside>
    <button class="mobile-menu-toggle">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    <div class="mobile-menu-overlay"></div>

    <main class="main-content scanline">
      <div class="container animate-fadeIn">

        <div class="st-header">
          <h1 style="font-size:2.5rem;font-family:'Space Grotesk',sans-serif;font-weight:700;color:white;text-transform:uppercase;">
            æ©Ÿé–¢å“¡ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼
          </h1>
          <p class="font-mono" style="font-size:.875rem;margin-top:.5rem;color:var(--muted-foreground);">
            AGENT SKILL TREE â€” å°‚é–€èƒ½åŠ›ã®æˆé•·è¨˜éŒ²
          </p>
        </div>

        <!-- Progress overview -->
        <div class="st-progress-row" id="stProgressRow"></div>

        <!-- Track selector -->
        <div class="track-selector" id="trackSelector"></div>

        <!-- Tree display -->
        <div class="st-tree-wrap">
          <div class="st-tree" id="skillTree"></div>
        </div>

      </div>
    </main>
  </div>

  <!-- Detail popup -->
  <div class="sk-overlay" id="skOverlay" onclick="closeDetail()"></div>
  <div class="sk-detail" id="skDetail"></div>

  <script src="./js/core/error-handler.js" defer></script>
  <script src="./js/data/data-bundle.js" defer></script>
  <script src="./js/core/loading.js" defer></script>
  <script src="./js/core/sidebar.js" defer></script>
  <script src="./js/core/bookmark.js" defer></script>
  <script src="./js/core/main.js" defer></script>
  <script src="./js/core/modal.js" defer></script>
  <script src="./js/core/progress.js" defer></script>
  <script src="./js/core/story-engine.js" defer></script>
  <script src="./js/core/notifications.js" defer></script>
  <script>
  (function(){
    if (!ProgressSystem.checkPageAccess('skill-tree.html')) {
      ModalSystem.warning('ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ LEVEL 1 ãŒå¿…è¦ã§ã™ã€‚','ACCESS DENIED')
        .then(function(){ Router.navigate('#/dashboard'); });
      return;
    }

    var SK_KEY = 'kaishoku_skills';
    var user = ProgressSystem.getUserData() || { level: 0 };
    var userLevel = user.level || 0;

    // â”€â”€ Skill data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var TRACKS = [
      {
        id: 'convergence', label: 'åæŸ', icon: 'âš¡', color: '#ef4444',
        skills: [
          { id:'sk_c1', icon:'ğŸ¯', name:'åŸºç¤åæŸè¡“', level:0, req:[], xp:0,
            desc:'æµ·è•ç¾è±¡ã¸ã®åŸºæœ¬çš„ãªå¯¾å‡¦æ³•ã‚’ç¿’å¾—ã€‚',
            effects:['XPç²å¾—é‡ +10%','ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šã®é–²è¦§è§£æ”¾'] },
          { id:'sk_c2', icon:'ğŸ›¡', name:'é˜²è­·ãƒ•ã‚©ãƒ¼ãƒ ', level:1, req:['sk_c1'], xp:50,
            desc:'å®Ÿä½“ã¨ã®æ¥è§¦æ™‚ã«è‡ªå·±é˜²è¡›ã‚’è¡Œã†å§¿å‹¢ã¨åˆ¤æ–­åŠ›ã€‚',
            effects:['ãƒãƒ£ãƒƒãƒˆã§ã®æƒ…å ±å…±æœ‰ XP +15','åæŸä½œæˆ¦é–¢é€£ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è§£æ”¾'] },
          { id:'sk_c3', icon:'âš”ï¸', name:'è¿‘æ¥åæŸ', level:2, req:['sk_c2'], xp:150,
            desc:'ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸè¿‘è·é›¢ã§ã®åæŸæŠ€è¡“ã€‚',
            effects:['ãƒŸãƒƒã‚·ãƒ§ãƒ³è©³ç´° XP +20%','é™å®šãƒŸãƒƒã‚·ãƒ§ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹'] },
          { id:'sk_c4', icon:'ğŸ’¥', name:'åæŸãƒã‚¹ã‚¿ãƒªãƒ¼', level:3, req:['sk_c3'], xp:350,
            desc:'è¤‡æ•°ã®å®Ÿä½“ã‚’åŒæ™‚ã«åæŸã•ã›ã‚‹é«˜åº¦ãªæŠ€è¡“ã€‚',
            effects:['å…¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ XP +25%','ä¸Šç´šãƒŸãƒƒã‚·ãƒ§ãƒ³ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯'] },
          { id:'sk_c5', icon:'ğŸŒ€', name:'æ¬¡å…ƒå›ºå®š', level:4, req:['sk_c4'], xp:700,
            desc:'æ¬¡å…ƒå¢ƒç•Œãã®ã‚‚ã®ã‚’ä¸€æ™‚çš„ã«å›ºå®šã™ã‚‹æœ€é«˜æŠ€è¡“ã€‚',
            effects:['M-019ä½¿ç”¨è³‡æ ¼ AAAä»˜ä¸','LEVEL5å°‚ç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸€éƒ¨è§£æ”¾'] },
        ]
      },
      {
        id: 'analysis', label: 'è§£æ', icon: 'ğŸ”¬', color: '#3b82f6',
        skills: [
          { id:'sk_a1', icon:'ğŸ“¡', name:'ç•°å¸¸æ„ŸçŸ¥', level:0, req:[], xp:0,
            desc:'æµ·è•ç¾è±¡ã®åˆæœŸå…†å€™ã‚’æ„ŸçŸ¥ã™ã‚‹è¨“ç·´ã€‚',
            effects:['ãƒãƒƒãƒ—æƒ…å ± è©³ç´°è¡¨ç¤º','å®Ÿä½“ã‚«ã‚¿ãƒ­ã‚°è§£æ”¾'] },
          { id:'sk_a2', icon:'ğŸ§¬', name:'å®Ÿä½“åˆ†é¡', level:1, req:['sk_a1'], xp:50,
            desc:'å®Ÿä½“ã®ç¨®é¡ã¨å±é™ºåº¦ã‚’æ­£ç¢ºã«è©•ä¾¡ã™ã‚‹èƒ½åŠ›ã€‚',
            effects:['å®Ÿä½“è©³ç´°ãƒšãƒ¼ã‚¸ XP +15','åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½è§£æ”¾'] },
          { id:'sk_a3', icon:'ğŸ“Š', name:'GSIæ¸¬å®š', level:2, req:['sk_a2'], xp:150,
            desc:'GSIå€¤ã‚’ç¾å ´ã§æ¸¬å®šãƒ»è§£é‡ˆã™ã‚‹æŠ€è¡“ã€‚',
            effects:['çµ±è¨ˆãƒšãƒ¼ã‚¸è§£æ”¾','é«˜ç²¾åº¦ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘ŠãŒå¯èƒ½ã«'] },
          { id:'sk_a4', icon:'ğŸ”­', name:'æ¬¡å…ƒè¦³æ¸¬', level:3, req:['sk_a3'], xp:350,
            desc:'æ¬¡å…ƒå¢ƒç•Œã®è–„åŒ–ã‚’äº‹å‰ã«äºˆæ¸¬ã™ã‚‹é«˜åº¦ãªåˆ†æã€‚',
            effects:['DEANç›£è¦–ç¶²ã‚¢ã‚¯ã‚»ã‚¹','äºˆæ¸¬è­¦å ±ã®é–²è¦§æ¨©é™'] },
          { id:'sk_a5', icon:'ğŸŒ', name:'å¢ƒç•Œç†è«–', level:4, req:['sk_a4'], xp:700,
            desc:'æ¬¡å…ƒé–“ã®å¢ƒç•Œç†è«–ã‚’å®Œå…¨ã«ç†è§£ã—ãŸç ”ç©¶è€…ãƒ¬ãƒ™ãƒ«ã€‚',
            effects:['ä¸–ç•Œè¨­å®šè¾å…¸ å…¨ã‚¨ãƒ³ãƒˆãƒªè§£æ”¾','ç ”ç©¶ãƒ«ãƒ¼ãƒˆé–‹æ”¾'] },
        ]
      },
      {
        id: 'intelligence', label: 'æƒ…å ±', icon: 'ğŸ•µï¸', color: '#8b5cf6',
        skills: [
          { id:'sk_i1', icon:'ğŸ‘', name:'è¦³å¯Ÿçœ¼', level:0, req:[], xp:0,
            desc:'ç¾å ´ã®çŠ¶æ³ã‚’æ­£ç¢ºã«è¦³å¯Ÿãƒ»è¨˜éŒ²ã™ã‚‹åŸºæœ¬èƒ½åŠ›ã€‚',
            effects:['é–²è¦§å±¥æ­´ è©³ç´°çµ±è¨ˆ','æ¤œç´¢æ©Ÿèƒ½è§£æ”¾'] },
          { id:'sk_i2', icon:'ğŸ—‚', name:'æƒ…å ±æ•´ç†', level:1, req:['sk_i1'], xp:50,
            desc:'åé›†ã—ãŸæƒ…å ±ã‚’ä½“ç³»çš„ã«æ•´ç†ãƒ»åˆ†æã™ã‚‹ã€‚',
            effects:['ã‚³ãƒ‡ãƒƒã‚¯ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹','ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ©Ÿèƒ½å¼·åŒ–'] },
          { id:'sk_i3', icon:'ğŸ”', name:'æ©Ÿå¯†å–æ‰±', level:2, req:['sk_i2'], xp:150,
            desc:'æ©Ÿå¯†æƒ…å ±ã‚’é©åˆ‡ã«å–ã‚Šæ‰±ã†èƒ½åŠ›ã¨è³‡æ ¼ã€‚',
            effects:['æ©Ÿå¯†é–‹ç¤ºç”³è«‹ãŒå¯èƒ½ã«','ä¸€éƒ¨CLASSIFIEDæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹'] },
          { id:'sk_i4', icon:'ğŸ“œ', name:'æ­´å²åˆ†æ', level:3, req:['sk_i3'], xp:350,
            desc:'æ©Ÿé–¢ã®æ­´å²çš„äº‹æ¡ˆã‚’æ·±ãç†è§£ã—ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’èª­ã‚€ã€‚',
            effects:['æ©Ÿé–¢å² æ©Ÿå¯†ã‚¨ãƒ³ãƒˆãƒªè§£æ”¾','éå»äº‹æ¡ˆã¨ã®ç…§åˆæ©Ÿèƒ½'] },
          { id:'sk_i5', icon:'ğŸ”®', name:'çœŸå®Ÿã®ç›®', level:4, req:['sk_i4'], xp:700,
            desc:'å…¨æƒ…å ±ã‚’çµ±åˆã—ã€éš ã•ã‚ŒãŸçœŸå®Ÿã«è¿«ã‚‹æ´å¯ŸåŠ›ã€‚',
            effects:['ARGçœŸã‚¨ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒˆè§£æ”¾','å…¨æ©Ÿå¯†æ–‡æ›¸ã‚¢ã‚¯ã‚»ã‚¹'] },
        ]
      },
      {
        id: 'field', label: 'ç¾å ´', icon: 'ğŸƒ', color: '#10b981',
        skills: [
          { id:'sk_f1', icon:'ğŸ§­', name:'ç¾å ´åˆ¤æ–­', level:0, req:[], xp:0,
            desc:'äºˆæœŸã—ãªã„çŠ¶æ³ã§ã®è¿…é€Ÿãªåˆ¤æ–­åŠ›ã‚’é›ãˆã‚‹ã€‚',
            effects:['ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆè§£æ”¾','ç¾å ´å ±å‘Š XP +10%'] },
          { id:'sk_f2', icon:'ğŸ¤', name:'é€£æºä½œæˆ¦', level:1, req:['sk_f1'], xp:50,
            desc:'ä»–ã®æ©Ÿé–¢å“¡ã¨ãƒãƒ¼ãƒ ã§å‹•ãéš›ã®é€£æºã‚¹ã‚­ãƒ«ã€‚',
            effects:['ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ XP +20%','ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ¦ãƒ­ã‚°é–²è¦§'] },
          { id:'sk_f3', icon:'ğŸš', name:'ç·Šæ€¥å¯¾å¿œ', level:2, req:['sk_f2'], xp:150,
            desc:'ç·Šæ€¥äº‹æ…‹ã«ãŠã‘ã‚‹è¿…é€Ÿã‹ã¤é©åˆ‡ãªåˆå‹•å¯¾å¿œã€‚',
            effects:['ç·Šæ€¥é€šå ±ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹','ç·Šæ€¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”³è«‹æ¨©é™'] },
          { id:'sk_f4', icon:'ğŸ—º', name:'åºƒåŸŸå±•é–‹', level:3, req:['sk_f3'], xp:350,
            desc:'åºƒã„ã‚¨ãƒªã‚¢ã«ã‚ãŸã‚‹è¤‡æ•°äº‹æ¡ˆã®åŒæ™‚å¯¾å¿œèƒ½åŠ›ã€‚',
            effects:['å…¨å›½ãƒãƒƒãƒ—è©³ç´°ã‚¢ã‚¯ã‚»ã‚¹','è¤‡æ•°ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†'] },
          { id:'sk_f5', icon:'ğŸŒŸ', name:'ä¼èª¬ã®æ©Ÿé–¢å“¡', level:4, req:['sk_f4'], xp:700,
            desc:'ã‚ã‚‰ã‚†ã‚‹çŠ¶æ³ã‚’ä¹—ã‚Šè¶ŠãˆãŸã€æ©Ÿé–¢æœ€é«˜å³°ã®ç¾å ´åŠ›ã€‚',
            effects:['å…¨éƒ¨é–€ãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹','æ©Ÿé–¢å“¡æ®¿å ‚å…¥ã‚Šè¨˜éŒ²'] },
        ]
      },
    ];

    var selectedTrack = 'convergence';
    var unlockedSkills = JSON.parse(localStorage.getItem(SK_KEY) || '[]');

    function isUnlocked(id) { return unlockedSkills.indexOf(id) >= 0; }
    function canUnlock(skill) {
      if (isUnlocked(skill.id)) return false;
      if (userLevel < skill.level) return false;
      return skill.req.every(isUnlocked);
    }

    // â”€â”€ Progress Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderProgress() {
      var el = document.getElementById('stProgressRow');
      el.innerHTML = TRACKS.map(function(t) {
        var total = t.skills.length;
        var done = t.skills.filter(function(s){ return isUnlocked(s.id); }).length;
        var pct = Math.round((done/total)*100);
        return '<div class="st-progress-card">' +
          '<div class="stp-track" style="color:' + t.color + '">' + t.icon + ' ' + t.label + 'ç³»</div>' +
          '<div class="stp-bar"><div class="stp-fill" style="width:' + pct + '%;background:' + t.color + '"></div></div>' +
          '<div class="stp-count">' + done + '/' + total + ' (' + pct + '%)</div>' +
          '</div>';
      }).join('');
    }

    // â”€â”€ Track Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTracks() {
      var el = document.getElementById('trackSelector');
      el.innerHTML = TRACKS.map(function(t) {
        return '<button class="track-btn ' + (t.id === selectedTrack ? 'active' : '') + '" ' +
          'style="--tc:' + t.color + '" onclick="selectTrack(\'' + t.id + '\')">' +
          t.icon + ' ' + t.label + 'ç³»ã‚¹ã‚­ãƒ«</button>';
      }).join('');
    }

    window.selectTrack = function(id) {
      selectedTrack = id;
      renderTracks();
      renderTree();
    };

    // â”€â”€ Tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTree() {
      var track = TRACKS.find(function(t){ return t.id === selectedTrack; });
      if (!track) return;
      var el = document.getElementById('skillTree');
      el.innerHTML = track.skills.map(function(skill, idx) {
        var unlocked = isUnlocked(skill.id);
        var available = canUnlock(skill);
        var stateClass = unlocked ? 'unlocked' : 'locked';
        var glowStyle = unlocked ? '--sk-color:' + track.color : '--sk-color:rgba(255,255,255,.2)';
        var connStyle = (idx < track.skills.length - 1)
          ? '<div class="sk-connector-down ' + (unlocked ? '' : 'locked') + '" style="--sk-color:' + track.color + '"></div>'
          : '';
        return '<div class="st-row" style="' + (idx === 0 ? 'margin-bottom:0' : 'margin-bottom:0') + '">' +
          '<div class="sk-node ' + stateClass + '" style="' + (idx === 0 ? '' : '') + '">' +
          '<div class="sk-bubble ' + stateClass + '" style="' + glowStyle + '" ' +
          'onclick="showDetail(\'' + skill.id + '\',\'' + selectedTrack + '\')">' +
          skill.icon +
          '<div class="sk-level-badge" style="' + (unlocked ? 'background:' + track.color : 'background:rgba(255,255,255,.15)') + '">L' + skill.level + '</div>' +
          '</div>' +
          connStyle +
          '<div class="sk-name">' + skill.name + '</div>' +
          '</div></div>';
      }).join('');
    }

    // â”€â”€ Detail Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.showDetail = function(skillId, trackId) {
      var track = TRACKS.find(function(t){ return t.id === trackId; });
      var skill = track && track.skills.find(function(s){ return s.id === skillId; });
      if (!skill) return;
      var unlocked = isUnlocked(skill.id);
      var available = canUnlock(skill);
      var reqNames = skill.req.map(function(r) {
        for (var i=0;i<TRACKS.length;i++) {
          var found = TRACKS[i].skills.find(function(s){ return s.id === r; });
          if (found) return found.name;
        }
        return r;
      });

      var btnHtml = '';
      if (unlocked) {
        btnHtml = '<button class="sdd-unlock-btn" disabled>âœ“ ç¿’å¾—æ¸ˆã¿</button>';
      } else if (available) {
        btnHtml = '<button class="sdd-unlock-btn" onclick="unlockSkill(\'' + skillId + '\')">â–¶ ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã™ã‚‹</button>';
      } else {
        btnHtml = '<button class="sdd-unlock-btn" disabled>ãƒ­ãƒƒã‚¯ä¸­</button>' +
          '<div class="sdd-locked-notice">' +
          (userLevel < skill.level ? 'LEVEL ' + skill.level + ' ãŒå¿…è¦ã§ã™' :
           'å‰æã‚¹ã‚­ãƒ«ã‚’å…ˆã«ç¿’å¾—ã—ã¦ãã ã•ã„') + '</div>';
      }

      var reqHtml = reqNames.length
        ? '<div class="sdd-req">å‰æ: ' + reqNames.join(' / ') + '</div>'
        : '<div class="sdd-req">å‰æã‚¹ã‚­ãƒ«ãªã—</div>';

      document.getElementById('skDetail').innerHTML =
        '<div class="sdd-header">' +
        '<div class="sdd-icon">' + skill.icon + '</div>' +
        '<div>' +
        '<div style="font-family:\'Space Grotesk\',sans-serif;font-size:1.1rem;font-weight:700;color:white;text-transform:uppercase;">' + skill.name + '</div>' +
        '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.68rem;color:' + track.color + ';margin-top:.2rem;">LEVEL ' + skill.level + ' | ' + track.label + 'ç³»</div>' +
        '</div>' +
        '<button class="sdd-close" onclick="closeDetail()">âœ•</button>' +
        '</div>' +
        '<p style="font-size:.875rem;color:var(--muted-foreground);line-height:1.6;">' + skill.desc + '</p>' +
        '<div class="sdd-effects">' +
        '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.65rem;color:' + track.color + ';text-transform:uppercase;margin-bottom:.5rem;">ç¿’å¾—åŠ¹æœ</div>' +
        skill.effects.map(function(e){ return '<div class="sdd-effect"><span class="sdd-bullet">â–¸</span><span>' + e + '</span></div>'; }).join('') +
        '</div>' +
        reqHtml +
        btnHtml;

      document.getElementById('skDetail').classList.add('open');
      document.getElementById('skOverlay').classList.add('open');
    };

    window.closeDetail = function() {
      document.getElementById('skDetail').classList.remove('open');
      document.getElementById('skOverlay').classList.remove('open');
    };

    window.unlockSkill = function(skillId) {
      if (isUnlocked(skillId)) return;
      unlockedSkills.push(skillId);
      localStorage.setItem(SK_KEY, JSON.stringify(unlockedSkills));
      ProgressSystem.trackActivity('mission_complete');
      closeDetail();
      renderProgress();
      renderTree();
      ModalSystem.success('ã‚¹ã‚­ãƒ«ç¿’å¾—å®Œäº†', 'ã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã—ã¾ã—ãŸ');
    };

    document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeDetail(); });

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    renderProgress();
    renderTracks();
    renderTree();
  })();
  </script>
</body>
</html>
