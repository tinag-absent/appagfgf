<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>実体詳細 - 海蝕機関</title>
  <link rel="icon" type="image/png" href="../images/favicon.png">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/mobile.css">
  <style>
    .back-button {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.75rem 1.5rem; background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1); color: var(--foreground);
      text-decoration: none; font-family: 'JetBrains Mono', monospace;
      transition: all 0.3s; margin-bottom: 2rem;
    }
    .back-button:hover { border-color: rgb(139,92,246); background: rgba(139,92,246,0.1); }

    /* Header */
    .entity-header {
      padding: 2rem; margin-bottom: 2rem; position: relative; overflow: hidden;
    }
    .entity-header::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(139,92,246,0.1));
      border: 2px solid;
    }
    .entity-header.cls-safe::before    { border-color: rgb(16,185,129); background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(0,0,0,0.3)); }
    .entity-header.cls-caution::before { border-color: rgb(245,158,11); background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(0,0,0,0.3)); }
    .entity-header.cls-danger::before  { border-color: rgb(239,68,68); background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(0,0,0,0.3)); }
    .entity-header.cls-classified::before { border-color: rgb(139,92,246); background: linear-gradient(135deg, rgba(139,92,246,0.12), rgba(0,0,0,0.3)); }

    .entity-header-inner { position: relative; z-index: 1; }
    .entity-code-line {
      font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
      color: var(--muted-foreground); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 1rem;
    }
    .cls-badge {
      display: inline-block; padding: 0.25rem 0.85rem;
      font-size: 0.7rem; font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase; border: 1px solid; letter-spacing: 0.08em;
    }
    .cls-safe      { border-color: rgb(16,185,129); color: rgb(16,185,129); background: rgba(16,185,129,0.12); }
    .cls-caution   { border-color: rgb(245,158,11); color: rgb(245,158,11); background: rgba(245,158,11,0.12); }
    .cls-danger    { border-color: rgb(239,68,68); color: rgb(239,68,68); background: rgba(239,68,68,0.12); }
    .cls-classified{ border-color: rgb(139,92,246); color: rgb(139,92,246); background: rgba(139,92,246,0.12); }

    .entity-name {
      font-size: 2.5rem; font-family: 'Space Grotesk', sans-serif;
      font-weight: 700; color: white; margin: 0.5rem 0;
    }
    .entity-origin { color: var(--muted-foreground); font-size: 0.9rem; }

    /* Stats row */
    .stat-chips { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem; }
    .stat-chip {
      padding: 0.6rem 1.2rem; background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-chip-label { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--muted-foreground); text-transform: uppercase; margin-bottom: 0.25rem; }
    .stat-chip-value { font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; }
    .threat-high { color: var(--destructive); }
    .threat-mid  { color: rgb(245,158,11); }
    .threat-low  { color: rgb(16,185,129); }

    /* Tabs */
    .tab-nav {
      display: flex; gap: 0; margin-bottom: 0;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .tab-btn {
      padding: 0.875rem 1.75rem; background: none; border: none;
      border-bottom: 3px solid transparent; color: var(--muted-foreground);
      cursor: pointer; font-family: 'JetBrains Mono', monospace;
      font-weight: 600; text-transform: uppercase; transition: all 0.25s;
      font-size: 0.8rem; margin-bottom: -2px;
    }
    .tab-btn:hover, .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; padding-top: 2rem; }
    .tab-content.active { display: block; animation: fadeIn 0.25s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

    /* Content blocks */
    .detail-block {
      background: rgba(26,39,56,0.4); border: 1px solid rgba(255,255,255,0.08);
      padding: 1.75rem; margin-bottom: 1.5rem;
    }
    .block-title {
      font-family: 'Space Grotesk', sans-serif; font-size: 1rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--primary); margin-bottom: 1.25rem;
      padding-bottom: 0.6rem; border-bottom: 1px solid rgba(0,255,255,0.15);
    }
    .detail-text {
      color: var(--foreground); line-height: 1.9; font-size: 0.9375rem;
    }
    .containment-block {
      background: rgba(0,0,0,0.4); border-left: 4px solid var(--destructive);
      padding: 1.5rem;
    }
    .containment-label {
      font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
      color: var(--destructive); text-transform: uppercase;
      letter-spacing: 0.1em; margin-bottom: 0.75rem; font-weight: 700;
    }

    /* Related missions */
    .mission-ref-card {
      background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08);
      padding: 1rem 1.25rem; margin-bottom: 0.75rem;
      cursor: pointer; transition: all 0.2s; display: flex;
      align-items: center; gap: 1rem; text-decoration: none;
    }
    .mission-ref-card:hover { border-color: var(--primary); background: rgba(0,255,255,0.04); }
    .mission-ref-id { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--muted-foreground); white-space: nowrap; }
    .mission-ref-title { color: white; font-size: 0.9rem; font-weight: 600; flex: 1; }
    .mission-ref-badges { display: flex; gap: 0.4rem; flex-shrink: 0; }
    .mini-badge {
      padding: 0.15rem 0.5rem; font-size: 0.6rem;
      font-family: 'JetBrains Mono', monospace; text-transform: uppercase; border: 1px solid;
    }
    .mb-active    { border-color: var(--destructive); color: var(--destructive); }
    .mb-completed { border-color: rgb(16,185,129); color: rgb(16,185,129); }
    .mb-monitoring{ border-color: rgb(245,158,11); color: rgb(245,158,11); }
    .mb-failed    { border-color: rgb(107,114,128); color: rgb(107,114,128); }
    .mb-critical  { border-color: var(--destructive); color: var(--destructive); }
    .mb-warning   { border-color: rgb(245,158,11); color: rgb(245,158,11); }
    .mb-safe      { border-color: var(--primary); color: var(--primary); }

    .no-related {
      text-align: center; padding: 2.5rem;
      font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
      color: var(--muted-foreground); border: 1px dashed rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar"></aside>
    <button class="mobile-menu-toggle">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    <div class="mobile-menu-overlay"></div>

    <main class="main-content scanline">
      <div class="container">
        <div class="space-y-12 animate-fadeIn">
          <a href="../entities.html" class="back-button">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            実体カタログに戻る
          </a>
          <div id="entityDetail"></div>
        </div>
      </div>
    </main>
  </div>
  <script src="../js/core/error-handler.js" defer></script>
  <script src="../js/data/data-bundle.js" defer></script>

  <script src="../js/core/loading.js" defer></script>
  <script src="../js/core/sidebar.js" defer></script>
  <script src="../js/core/main.js" defer></script>
  <script src="../js/core/modal.js" defer></script>
  <script src="../js/core/progress.js" defer></script>
  <script src="../js/core/level-messages.js" defer></script>
  <script src="../js/core/daily-login.js" defer></script>
  <script src="../js/data/mission-data.js" defer></script>
  <script src="../js/data/catalog-data.js" defer></script>
  <script src="../js/core/view-history.js" defer></script>
  <script src="../js/core/bookmark.js" defer></script>
  <script>
  (async function() {
    if (!ProgressSystem.checkPageAccess('details/entity-detail.html')) {
      ModalSystem.warning('このページにアクセスするには LEVEL 3 が必要です。', 'ACCESS DENIED')
        .then(() => { window.location.href = '../dashboard.html'; });
      return;
    }
    await Promise.all([
      window.CatalogData.whenReady(),
      window.MissionData.whenReady()
    ]);

    const id = new URLSearchParams(window.location.search).get('id');
    const entity = window.CatalogData.entities.find(e => e.id === id || e.code === id);

    if (!entity) {
      ModalSystem.error('指定された実体が見つかりません。', 'NOT FOUND')
        .then(() => { window.location.href = '../entities.html'; });
      return;
    }

    document.title = `${entity.name} - 海蝕機関`;
    ViewHistory.record('entity', entity.id, entity.name);


    const CLASS_LABEL = { safe:'SAFE', caution:'CAUTION', danger:'DANGER', classified:'CLASSIFIED' };
    const THREAT_CLASS = { '高':'threat-high', '中':'threat-mid', '低':'threat-low' };
    const STATUS_LABEL = { active:'対応中', monitoring:'監視中', completed:'収束済み', failed:'失敗' };
    const PRIORITY_LABEL = { critical:'重大', warning:'警戒', safe:'観察' };

    // Find related missions
    const relatedMissions = window.MissionData.missions.filter(m =>
      m.entity && (m.entity.includes(entity.code) || m.entity.includes(entity.name))
    );

    const container = document.getElementById('entityDetail');
    container.innerHTML = `
      <div class="entity-header cls-${entity.classification}">
        <div class="entity-header-inner">
          <div class="entity-code-line">
            <span>${entity.id} / ${entity.code}</span>
            <span class="cls-badge cls-${entity.classification}">${CLASS_LABEL[entity.classification]}</span>
          </div>
          <div class="entity-name">${entity.name}</div>
          <div class="entity-origin">起源: ${entity.origin}</div>
          <div class="stat-chips">
            <div class="stat-chip">
              <div class="stat-chip-label">脅威度</div>
              <div class="stat-chip-value ${THREAT_CLASS[entity.threat] || ''}">${entity.threat}</div>
            </div>
            <div class="stat-chip">
              <div class="stat-chip-label">知性</div>
              <div class="stat-chip-value">${entity.intelligence}</div>
            </div>
            <div class="stat-chip">
              <div class="stat-chip-label">関連案件</div>
              <div class="stat-chip-value" style="color:var(--primary);">${relatedMissions.length}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-nav">
        <button class="tab-btn active" data-tab="overview">概要</button>
        <button class="tab-btn" data-tab="behavior">行動パターン</button>
        <button class="tab-btn" data-tab="containment">収束プロトコル</button>
        <button class="tab-btn" data-tab="missions">関連案件 <span style="font-size:0.65rem;opacity:0.7;">(${relatedMissions.length})</span></button>
      </div>

      <!-- Overview -->
      <div class="tab-content active" id="overview">
        <div class="detail-block">
          <div class="block-title">基本情報</div>
          <div class="detail-text">${entity.description}</div>
        </div>
        <div class="detail-block">
          <div class="block-title">外見</div>
          <div class="detail-text">${entity.appearance}</div>
        </div>
      </div>

      <!-- Behavior -->
      <div class="tab-content" id="behavior">
        <div class="detail-block">
          <div class="block-title">行動パターン</div>
          <div class="detail-text">${entity.behavior}</div>
        </div>
      </div>

      <!-- Containment -->
      <div class="tab-content" id="containment">
        <div class="containment-block">
          <div class="containment-label">⚠ 収束プロトコル / CONTAINMENT PROCEDURE</div>
          <div class="detail-text">${entity.containment}</div>
        </div>
      </div>

      <!-- Related Missions -->
      <div class="tab-content" id="missions">
        ${relatedMissions.length === 0
          ? `

    // ブックマークボタンを挿入
    (function() {
      var btn = BookmarkSystem.render('entity', entity.id, entity.name);
      var titleEl = document.querySelector('.entity-name');
      if (titleEl && titleEl.parentElement) {
        var wrap = document.createElement('div');
        wrap.style.cssText = 'display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:0.5rem;';
        titleEl.parentElement.insertBefore(wrap, titleEl);
        wrap.appendChild(titleEl);
        wrap.appendChild(btn);
      }
    })();<div class="no-related">記録された関連案件はありません</div>`
          : relatedMissions.map(m => `
            <a class="mission-ref-card" href="./mission-detail.html?id=${m.id}">
              <div class="mission-ref-id">${m.id}</div>
              <div class="mission-ref-title">${m.title}</div>
              <div class="mission-ref-badges">
                <span class="mini-badge mb-${m.status}">${STATUS_LABEL[m.status]||m.status}</span>
                <span class="mini-badge mb-${m.priority}">${PRIORITY_LABEL[m.priority]||m.priority}</span>
              </div>
            </a>`).join('')
        }
      </div>
    `;

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(this.dataset.tab).classList.add('active');
      });
    });

    ProgressSystem.trackActivity('phenomenon_view');
  })();
  </script>
</body>
</html>
